<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Dashboard</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        .loader {border-top-color: #4F46E5;animation: spinner 1.5s linear infinite;}
        @keyframes spinner {0% { transform: rotate(0deg); }100% { transform: rotate(360deg); }}
        .modal {display: none;position: fixed;z-index: 50;left: 0;top: 0;width: 100%;height: 100%;overflow: auto;background-color: rgba(0,0,0,0.4);}
        .modal-content {background-color: #fefefe;margin: 10% auto;padding: 30px;border: 1px solid #888;border-radius: 12px;width: 90%;max-width: 500px;box-shadow: 0 4px 6px rgba(0,0,0,0.1);}
        .modal-body {margin: 20px 0;}
        .modal-footer {display: flex;justify-content: flex-end;gap: 10px;margin-top: 20px;}
        .calc-box {background: #f3f4f6;padding: 12px;border-radius: 8px;margin-top: 16px;}
        .calc-row {display: flex;justify-content: space-between;padding: 8px 0;border-bottom: 1px solid #e5e7eb;}
        .calc-row:last-child {border-bottom: none;font-weight: 600;font-size: 1.1em;color: #4F46E5;}
    </style>
</head>
<body class="bg-gray-100">
    <div class="min-h-screen">
        <nav class="bg-white shadow-lg">
            <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
                <div class="flex justify-between h-16">
                    <div class="flex items-center"><h1 class="text-2xl font-bold text-indigo-600">Admin Dashboard</h1></div>
                    <div class="flex items-center gap-4">
                        <span id="admin-email" class="text-sm text-gray-600"></span>
                        <button id="logout-btn" class="bg-red-500 hover:bg-red-600 text-white px-4 py-2 rounded-md text-sm font-medium">로그아웃</button>
                    </div>
                </div>
            </div>
        </nav>
        <div class="max-w-7xl mx-auto py-6 sm:px-6 lg:px-8">
            <div class="px-4 py-6 sm:px-0">
                <h2 class="text-3xl font-bold text-gray-900 mb-6">전체 DB 승인 관리</h2>
                <p class="text-gray-600 mb-8">Tally에서 유입된 DB 목록을 확인하고 승인합니다.</p>
                <div id="error-message" class="hidden bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded relative mb-4" role="alert">
                    <strong class="font-bold">오류!</strong><span class="block sm:inline" id="error-text"></span>
                </div>
                <div class="bg-white shadow-lg rounded-xl overflow-hidden">
                    <div class="overflow-x-auto">
                        <table class="min-w-full divide-y divide-gray-200">
                            <thead class="bg-gray-50">
                                <tr>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">제출 시간</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">고객 성함</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">영업 코드</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">판매금액</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">수익률</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">최종금액</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">상태</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">관리</th>
                                </tr>
                            </thead>
                            <tbody id="db-table-body" class="bg-white divide-y divide-gray-200">
                                <tr id="loading-row">
                                    <td colspan="8" class="px-6 py-4 text-center text-gray-500">
                                        <div class="flex justify-center items-center">
                                            <div class="loader ease-linear rounded-full border-4 border-t-4 border-gray-200 h-6 w-6 mr-2"></div>
                                            데이터를 불러오는 중입니다...
                                        </div>
                                    </td>
                                </tr>
                                <tr id="no-data-row" class="hidden"><td colspan="8" class="px-6 py-4 text-center text-gray-500">아직 유입된 DB가 없습니다.</td></tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <div id="approve-modal" class="modal">
        <div class="modal-content">
            <h3 class="text-lg leading-6 font-medium text-gray-900">DB 승인 확인</h3>
            <div class="modal-body">
                <p class="text-sm text-gray-500 mb-4">정말로 이 DB를 승인하시겠습니까?<br>고객명: <strong id="modal-customer-name"></strong><br>영업 코드: <strong id="modal-ref-code"></strong></p>
                <div class="mb-4">
                    <label for="sale-amount-input" class="block text-sm font-medium text-gray-700">판매금액 (원)</label>
                    <input type="number" id="sale-amount-input" value="0" class="shadow-sm focus:ring-indigo-500 focus:border-indigo-500 block w-full sm:text-sm border-gray-300 rounded-md p-2 mt-1" placeholder="예: 259000">
                </div>
                <div class="mb-2"><span class="text-sm text-gray-600">파트너 수익률: <strong id="modal-commission-rate" class="text-indigo-600">0%</strong></span></div>
                <div class="calc-box">
                    <div class="calc-row"><span class="text-sm text-gray-600">수익금 (판매금액 × 수익률)</span><span class="text-sm font-medium" id="calc-commission">₩0</span></div>
                    <div class="calc-row"><span class="text-sm text-gray-600">원천징수 (3.3%)</span><span class="text-sm font-medium text-red-600" id="calc-tax">-₩0</span></div>
                    <div class="calc-row"><span class="text-sm">최종 정산금액</span><span class="text-sm" id="calc-final">₩0</span></div>
                </div>
            </div>
            <div class="modal-footer">
                <button id="modal-cancel" type="button" class="bg-white py-2 px-4 border border-gray-300 rounded-md shadow-sm text-sm font-medium text-gray-700 hover:bg-gray-50">취소</button>
                <button id="modal-confirm" type="button" class="bg-indigo-600 py-2 px-4 border border-transparent rounded-md shadow-sm text-sm font-medium text-white hover:bg-indigo-700">승인</button>
            </div>
        </div>
    </div>
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
        import { getFirestore, collection, query, where, getDocs } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";
        const firebaseConfig = {apiKey: "AIzaSyAPPv0oCq1OMiSt5oV-Wt2MIfzYOr6SsR0",authDomain: "tally-f9d9b.firebaseapp.com",projectId: "tally-f9d9b",storageBucket: "tally-f9d9b.firebasestorage.app",messagingSenderId: "643827486656",appId: "1:643827486656:web:29f3f74fd7b11c4e0d7237",measurementId: "G-ZG0N9R3LGF"};
        const GAS_URL = "/.netlify/functions/sheets-proxy";
        const ADMIN_EMAIL = "jsicoffee@naver.com";
        try{const app = initializeApp(firebaseConfig);window.auth = getAuth(app);window.db = getFirestore(app);}catch(error){console.error("Firebase 초기화 오류:", error);alert("Firebase 초기화 실패: " + error.message);}
        const adminEmail = document.getElementById('admin-email');
        const logoutBtn = document.getElementById('logout-btn');
        const dbTableBody = document.getElementById('db-table-body');
        const loadingRow = document.getElementById('loading-row');
        const noDataRow = document.getElementById('no-data-row');
        const errorMessage = document.getElementById('error-message');
        const errorText = document.getElementById('error-text');
        const approveModal = document.getElementById('approve-modal');
        const modalCustomerName = document.getElementById('modal-customer-name');
        const modalRefCode = document.getElementById('modal-ref-code');
        const modalCommissionRate = document.getElementById('modal-commission-rate');
        const saleAmountInput = document.getElementById('sale-amount-input');
        const calcCommission = document.getElementById('calc-commission');
        const calcTax = document.getElementById('calc-tax');
        const calcFinal = document.getElementById('calc-final');
        const modalCancel = document.getElementById('modal-cancel');
        const modalConfirm = document.getElementById('modal-confirm');
        let currentRowNumber = null;
        let currentCommissionRate = 0;
        onAuthStateChanged(window.auth, async (user) => {
            if (user) {
                if (user.email !== ADMIN_EMAIL) {alert("관리자만 접근할 수 있습니다.");await signOut(window.auth);window.location.href = '/index.html';return;}
                adminEmail.textContent = user.email;loadAllDbs();
            } else {window.location.href = '/index.html';}
        });
        logoutBtn.addEventListener('click', async () => {try{await signOut(window.auth);window.location.href = '/index.html';}catch(error){console.error("로그아웃 오류:", error);alert("로그아웃 실패: " + error.message);}});
        async function loadAllDbs() {errorMessage.classList.add('hidden');dbTableBody.innerHTML = '';dbTableBody.appendChild(loadingRow);try{const response = await fetch(`${GAS_URL}?action=getAllDbs&cachebust=${new Date().getTime()}`);const result = await response.json();if (result.success) {await displayDbs(result.data);} else {throw new Error(result.message);}}catch(error){console.error("데이터 로드 오류:", error);showError(error.message);}}
        async function getPartnerCommissionRate(referralCode) {try{const partnersRef = collection(window.db, 'partners');const q = query(partnersRef, where('referralCode', '==', referralCode));const querySnapshot = await getDocs(q);if (!querySnapshot.empty) {const partnerData = querySnapshot.docs[0].data();return partnerData.commissionRate || 20;}return 20;}catch(error){console.error("수익률 조회 오류:", error);return 20;}}
        async function displayDbs(dbs) {loadingRow.classList.add('hidden');dbTableBody.innerHTML = '';if (dbs.length === 0) {dbTableBody.appendChild(noDataRow);noDataRow.classList.remove('hidden');return;}
            dbs.sort((a, b) => {const dateA = a.submittedAt ? new Date(a.submittedAt.replace('오전', 'AM').replace('오후', 'PM')) : new Date(0);const dateB = b.submittedAt ? new Date(b.submittedAt.replace('오전', 'AM').replace('오후', 'PM')) : new Date(0);return dateB - dateA;});
            for (const db of dbs) {
                const tr = document.createElement('tr');tr.className = (db.status === '승인됨') ? 'bg-green-50' : '';
                let submittedDate = "N/A";if (db.submittedAt) {try{const dateStr = db.submittedAt.replace('오전', 'AM').replace('오후', 'PM');submittedDate = new Date(dateStr).toLocaleString('ko-KR', { year: 'numeric', month: '2-digit', day: '2-digit', hour: '2-digit', minute: '2-digit', hour12: false });}catch(e){submittedDate = db.submittedAt;}}
                const saleAmountFormatted = new Intl.NumberFormat('ko-KR', { style: 'currency', currency: 'KRW' }).format(db.saleAmount || 0);
                const finalAmountFormatted = new Intl.NumberFormat('ko-KR', { style: 'currency', currency: 'KRW' }).format(db.finalAmount || 0);
                const commissionRateText = `${db.commissionRate || 0}%`;
                let statusBadge;if (db.status === '승인됨') {statusBadge = `<span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full bg-green-100 text-green-800">승인됨</span>`;} else if (db.status === '취소됨') {statusBadge = `<span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full bg-red-100 text-red-800">취소됨</span>`;} else {statusBadge = `<span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full bg-yellow-100 text-yellow-800">대기중</span>`;}
                let actionButton;if (db.status === '승인됨') {actionButton = `<button data-row="${db.rowNumber}" data-name="${db.customerName}" data-ref="${db.referralCode}" data-sale="${db.saleAmount || 0}" data-rate="${db.commissionRate || 0}" class="edit-btn bg-gray-500 hover:bg-gray-600 text-white px-3 py-1 rounded-md text-xs font-medium">수정</button>`;} else {actionButton = `<button data-row="${db.rowNumber}" data-name="${db.customerName}" data-ref="${db.referralCode}" class="approve-btn bg-indigo-600 hover:bg-indigo-700 text-white px-3 py-1 rounded-md text-xs font-medium">승인</button>`;}
                tr.innerHTML = `<td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${submittedDate}</td><td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">${db.customerName || 'N/A'}</td><td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${db.referralCode || 'N/A'}</td><td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${saleAmountFormatted}</td><td class="px-6 py-4 whitespace-nowrap text-sm text-gray-600">${commissionRateText}</td><td class="px-6 py-4 whitespace-nowrap text-sm font-semibold text-indigo-600">${finalAmountFormatted}</td><td class="px-6 py-4 whitespace-nowrap">${statusBadge}</td><td class="px-6 py-4 whitespace-nowrap text-sm font-medium">${actionButton}</td>`;
                dbTableBody.appendChild(tr);
            }
            document.querySelectorAll('.approve-btn, .edit-btn').forEach(btn => {btn.addEventListener('click', async (e) => {const button = e.target;currentRowNumber = button.getAttribute('data-row');const customerName = button.getAttribute('data-name');const refCode = button.getAttribute('data-ref');currentCommissionRate = await getPartnerCommissionRate(refCode);modalCustomerName.textContent = customerName;modalRefCode.textContent = refCode;modalCommissionRate.textContent = `${currentCommissionRate}%`;if (button.classList.contains('edit-btn')) {const saleAmount = button.getAttribute('data-sale');saleAmountInput.value = saleAmount || 0;updateCalculation();} else {saleAmountInput.value = 0;updateCalculation();}approveModal.style.display = 'block';});});
        }
        function updateCalculation() {const saleAmount = parseFloat(saleAmountInput.value) || 0;const commissionRate = currentCommissionRate / 100;const taxRate = 0.033;const commission = Math.round(saleAmount * commissionRate);const tax = Math.round(commission * taxRate);const finalAmount = commission - tax;calcCommission.textContent = new Intl.NumberFormat('ko-KR', { style: 'currency', currency: 'KRW' }).format(commission);calcTax.textContent = '-' + new Intl.NumberFormat('ko-KR', { style: 'currency', currency: 'KRW' }).format(tax);calcFinal.textContent = new Intl.NumberFormat('ko-KR', { style: 'currency', currency: 'KRW' }).format(finalAmount);}
        saleAmountInput.addEventListener('input', updateCalculation);
        modalCancel.addEventListener('click', () => {approveModal.style.display = 'none';});
        window.addEventListener('click', (event) => {if (event.target == approveModal) {approveModal.style.display = 'none';}});
        modalConfirm.addEventListener('click', async () => {const status = '승인됨';const saleAmount = parseFloat(saleAmountInput.value) || 0;const commissionRate = currentCommissionRate;const rowNumber = currentRowNumber;if (saleAmount <= 0) {alert('판매금액을 입력해주세요.');return;}modalConfirm.disabled = true;modalConfirm.textContent = '처리중...';try{const response = await fetch(GAS_URL, {method: 'POST',body: JSON.stringify({action: 'updateDbStatus',rowNumber: rowNumber,status: status,saleAmount: saleAmount,commissionRate: commissionRate}),headers: {'Content-Type': 'application/json'}});const result = await response.json();if (result.success) {approveModal.style.display = 'none';loadAllDbs();} else {throw new Error(result.message);}}catch(error){console.error("승인 처리 오류:", error);alert("승인 처리 실패: " + error.message);}finally{modalConfirm.disabled = false;modalConfirm.textContent = '승인';}});
        function showError(message) {loadingRow.classList.add('hidden');noDataRow.classList.add('hidden');dbTableBody.innerHTML = '';errorText.textContent = message;errorMessage.classList.remove('hidden');}
    </script>
</body>
</html>
