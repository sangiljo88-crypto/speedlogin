<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sales Dashboard</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore-compat.js"></script>
    <style>
        body { font-family: 'Inter', sans-serif; }
        .loader {
            border-top-color: #3498db;
            -webkit-animation: spin 1s linear infinite;
            animation: spin 1s linear infinite;
        }
        @-webkit-keyframes spin {
            0% { -webkit-transform: rotate(0deg); }
            100% { -webkit-transform: rotate(360deg); }
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body class="bg-gray-100 min-h-screen">

    <nav class="bg-white shadow-sm">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex justify-between h-16">
                <div class="flex-shrink-0 flex items-center">
                    <h1 class="text-2xl font-bold text-indigo-600">Sales Dashboard</h1>
                </div>
                <div id="nav-user" class="flex items-center hidden">
                    <span id="user-email" class="text-sm text-gray-700 mr-4"></span>
                    <button id="logout-button" class="bg-red-500 hover:bg-red-600 text-white px-3 py-1.5 rounded-md text-sm font-medium">
                        ë¡œê·¸ì•„ì›ƒ
                    </button>
                </div>
            </div>
        </div>
    </nav>

    <div id="main-container" class="py-10 max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
        
        <div id="loading-spinner" class="flex justify-center items-center h-[70vh]">
            <div class="flex flex-col items-center">
                <div class="loader ease-linear rounded-full border-8 border-t-8 border-gray-200 h-24 w-24 mb-4"></div>
                <h2 class="text-xl font-semibold text-gray-600">ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ì…ë‹ˆë‹¤...</h2>
            </div>
        </div>
        
        <div id="dashboard-content" class="hidden">
            <div id="error-message" class="hidden bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded-lg relative mb-6" role="alert">
                <strong class="font-bold">ë°ì´í„° ë¡œë“œ ì‹¤íŒ¨:</strong>
                <span id="error-text" class="block sm:inline"></span>
            </div>

            <header class="mb-8 md:flex md:items-center md:justify-between">
                <div>
                    <h2 id="welcome-title" class="text-3xl font-bold leading-7 text-gray-900 sm:text-4xl sm:truncate">
                        íŒŒíŠ¸ë„ˆë‹˜ì˜ ëŒ€ì‹œë³´ë“œ
                    </h2>
                    <p class="mt-1 text-lg text-gray-500">íŒŒíŠ¸ë„ˆë‹˜ì˜ ì‹¤ì ì„ í™•ì¸í•˜ì„¸ìš”.</p>
                </div>
                <div class="mt-4 md:mt-0 md:ml-4 flex-shrink-0">
                    <label for="ref-link" class="block text-sm font-medium text-gray-700">ë‚´ ì˜ì—… ë§í¬</label>
                    <div class="mt-1 flex rounded-md shadow-sm">
                        <input type="text" id="ref-link" readonly class="focus:ring-indigo-500 focus:border-indigo-500 flex-1 block w-full rounded-none rounded-l-md sm:text-sm border-gray-300 bg-gray-50 p-2">
                        <button id="copy-link-button" type="button" class="-ml-px relative inline-flex items-center space-x-2 px-4 py-2 border border-gray-300 text-sm font-medium rounded-r-md text-gray-700 bg-gray-50 hover:bg-gray-100 focus:outline-none">
                            <span>ë³µì‚¬</span>
                        </button>
                    </div>
                </div>
            </header>

            <!-- ìˆ˜ìµ í˜„í™© (4ê°œ ì¹´ë“œ) -->
            <section class="mb-10">
                <h3 class="text-2xl font-semibold text-gray-900 mb-2">ì´ë²ˆ ë‹¬ ìˆ˜ìµ í˜„í™©</h3>
                <p class="text-sm text-gray-600 mb-4">ì§€ê¸‰ ì˜ˆì •ì¼: <span id="payment-date" class="font-semibold text-indigo-600">ìµì›” 10ì¼</span></p>
                <div class="grid grid-cols-1 md:grid-cols-4 gap-6">
                    <div class="bg-white shadow-lg rounded-xl p-6">
                        <h4 class="text-sm font-medium text-gray-500">ì´ íŒë§¤ì•¡</h4>
                        <p id="current-month-sales" class="mt-2 text-3xl font-bold text-gray-900">â‚©0</p>
                    </div>
                    <div class="bg-white shadow-lg rounded-xl p-6">
                        <h4 class="text-sm font-medium text-gray-500">ì´ ìˆ˜ìµê¸ˆ</h4>
                        <p id="current-month-commission" class="mt-2 text-3xl font-bold text-blue-600">â‚©0</p>
                        <p class="text-xs text-gray-500 mt-1">ì›ì²œì§•ìˆ˜ ì „</p>
                    </div>
                    <div class="bg-white shadow-lg rounded-xl p-6">
                        <h4 class="text-sm font-medium text-gray-500">ì›ì²œì§•ìˆ˜ í•©ê³„</h4>
                        <p id="current-month-tax" class="mt-2 text-3xl font-bold text-red-600">â‚©0</p>
                        <p class="text-xs text-gray-500 mt-1">3.3%</p>
                    </div>
                    <div class="bg-white shadow-lg rounded-xl p-6">
                        <h4 class="text-sm font-medium text-gray-500">ìµœì¢… ì •ì‚° ì˜ˆì •ì•¡</h4>
                        <p id="current-month-final" class="mt-2 text-3xl font-bold text-green-600">â‚©0</p>
                    </div>
                </div>
            </section>

            <!-- DB ìœ ì… í˜„í™© -->
            <section class="mb-10">
                <h3 class="text-2xl font-semibold text-gray-900 mb-4">DB ìœ ì… í˜„í™©</h3>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div class="bg-white shadow-lg rounded-xl p-6">
                        <h4 class="text-sm font-medium text-gray-500">ì´ë²ˆ ë‹¬ ì´ DB ìœ ì…</h4>
                        <p id="current-month-db-count" class="mt-2 text-4xl font-bold text-gray-900">0 ê±´</p>
                        <p id="current-month-db-detail" class="mt-1 text-sm text-gray-500">(ìŠ¹ì¸ 0ê±´)</p>
                    </div>
                    <div class="bg-white shadow-lg rounded-xl p-6">
                        <h4 class="text-sm font-medium text-gray-500">ëˆ„ì  ì´ DB ìœ ì…</h4>
                        <p id="total-db-count" class="mt-2 text-4xl font-bold text-gray-900">0 ê±´</p>
                        <p id="total-db-detail" class="mt-1 text-sm text-gray-500">(ìŠ¹ì¸ 0ê±´)</p>
                    </div>
                </div>
            </section>

            <!-- DB ëª©ë¡ -->
            <section>
                <h3 class="text-2xl font-semibold text-gray-900 mb-4">ë‚´ DB ëª©ë¡ (ìµœì‹ ìˆœ)</h3>
                <div class="bg-white shadow-lg rounded-xl overflow-hidden">
                    <div class="overflow-x-auto">
                        <table class="min-w-full divide-y divide-gray-200">
                            <thead class="bg-gray-50">
                                <tr>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">ì œì¶œ ì‹œê°„</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">ê³ ê° ì„±í•¨</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">íŒë§¤ê¸ˆì•¡</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">ìˆ˜ìµê¸ˆ</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">ì›ì²œì§•ìˆ˜</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">ì •ì‚°ì˜ˆì •ì•¡</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">ì§€ê¸‰ì˜ˆì •ì¼</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">ìƒíƒœ</th>
                                </tr>
                            </thead>
                            <tbody id="db-list-tbody" class="bg-white divide-y divide-gray-200">
                                <tr>
                                    <td colspan="8" class="px-6 py-8 text-center text-gray-500">ì•„ì§ ìœ ì…ëœ DBê°€ ì—†ìŠµë‹ˆë‹¤.</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </section>
        </div>
    </div>

    <script>
        // ==================== ì„¤ì • ====================
        
        const firebaseConfig = {
          apiKey: "AIzaSyA7eBsXhWAZBvaus9aovVf0GQeMEzvr1R4",
          authDomain: "speedlanding-dc186.firebaseapp.com",
          projectId: "speedlanding-dc186",
          storageBucket: "speedlanding-dc186.firebasestorage.app",
          messagingSenderId: "392587509521",
          appId: "1:392587509521:web:2679d3da4f9bb2e23156b0",
          measurementId: "G-ZG0N9R3LGF"
        };
        
        const GAS_URL = "/.netlify/functions/sheets-proxy";
        const BASE_URL = "https://brandforyou.kr"; // â­ ë³€ê²½!

        try {
          firebase.initializeApp(firebaseConfig);
        } catch (error) {
          console.error("Firebase ì´ˆê¸°í™” ì˜¤ë¥˜:", error);
        }

        const auth = firebase.auth();
        const db = firebase.firestore();

        let currentUser = null;
        let myDbs = [];
        let myReferralCode = null;

        // ==================== í•œêµ­ ì‹œê°„ í¬ë§·íŒ… ====================
        function formatKoreanDateTime(dateString) {
            if (!dateString) return 'N/A';
            
            try {
                const date = new Date(dateString);
                
                // í•œêµ­ ì‹œê°„ìœ¼ë¡œ í‘œì‹œ
                return date.toLocaleString('ko-KR', { 
                    timeZone: 'Asia/Seoul',
                    year: 'numeric',
                    month: '2-digit',
                    day: '2-digit',
                    hour: '2-digit',
                    minute: '2-digit',
                    hour12: false
                }).replace(/\. /g, '-').replace('.', '');
            } catch (error) {
                console.error('ë‚ ì§œ í¬ë§· ì˜¤ë¥˜:', error);
                return dateString;
            }
        }

        function formatKoreanDate(dateString) {
            if (!dateString) return '-';
            
            try {
                const date = new Date(dateString);
                
                return date.toLocaleDateString('ko-KR', { 
                    timeZone: 'Asia/Seoul',
                    year: 'numeric',
                    month: '2-digit',
                    day: '2-digit'
                }).replace(/\. /g, '-').replace('.', '');
            } catch (error) {
                console.error('ë‚ ì§œ í¬ë§· ì˜¤ë¥˜:', error);
                return dateString;
            }
        }

        // ==================== ë¡œê·¸ì¸ ì²´í¬ ====================
        auth.onAuthStateChanged(async (user) => {
            if (user) {
                currentUser = user;
                document.getElementById('user-email').textContent = user.email;
                document.getElementById('nav-user').classList.remove('hidden');
                
                try {
                    const doc = await db.collection('users').doc(user.uid).get();
                    if (doc.exists) {
                        const data = doc.data();
                        myReferralCode = data.referralCode;
                        
                        if (!myReferralCode) {
                            showError('referralCodeê°€ ì„¤ì •ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.');
                            return;
                        }
                        
                        document.getElementById('ref-link').value = `${BASE_URL}?ref=${myReferralCode}`;
                        await loadMyDbs();
                    } else {
                        showError('ì‚¬ìš©ì ì •ë³´ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
                    }
                } catch (error) {
                    console.error('ì‚¬ìš©ì ì •ë³´ ë¡œë“œ ì‹¤íŒ¨:', error);
                    showError('ì‚¬ìš©ì ì •ë³´ë¥¼ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
                }
            } else {
                window.location.href = "index.html";
            }
        });

        // ==================== ë¡œê·¸ì•„ì›ƒ ====================
        document.getElementById('logout-button').addEventListener('click', () => {
            auth.signOut().then(() => {
                window.location.href = "index.html";
            });
        });

        // ==================== ë§í¬ ë³µì‚¬ ====================
        document.getElementById('copy-link-button').addEventListener('click', () => {
            const linkInput = document.getElementById('ref-link');
            linkInput.select();
            document.execCommand('copy');
            alert('ì˜ì—… ë§í¬ê°€ ë³µì‚¬ë˜ì—ˆìŠµë‹ˆë‹¤!');
        });

        // ==================== DB ë°ì´í„° ë¡œë“œ ====================
        async function loadMyDbs() {
            try {
                console.log(`ğŸ“Š DB ë°ì´í„° ë¡œë“œ ì‹œì‘: ${myReferralCode}`);
                const startTime = performance.now();

                const response = await fetch(`${GAS_URL}?action=getDbsByRef&ref=${myReferralCode}`);
                const result = await response.json();

                const endTime = performance.now();
                console.log(`âœ… DB ë°ì´í„° ë¡œë“œ ì™„ë£Œ (${Math.round(endTime - startTime)}ms)`);

                if (!result.success) {
                    throw new Error(result.message || "ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.");
                }

                myDbs = result.data;
                renderDashboard();
                document.getElementById('loading-spinner').classList.add('hidden');
                document.getElementById('dashboard-content').classList.remove('hidden');

            } catch (error) {
                console.error("DB ë¡œë“œ ì‹¤íŒ¨:", error);
                showError("ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ”ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤: " + error.message);
                document.getElementById('loading-spinner').classList.add('hidden');
                document.getElementById('dashboard-content').classList.remove('hidden');
            }
        }

        // ==================== ëŒ€ì‹œë³´ë“œ ë Œë”ë§ ====================
        function renderDashboard() {
            const now = new Date();
            const currentMonth = now.getMonth();
            const currentYear = now.getFullYear();

            // ì´ë²ˆ ë‹¬ ë°ì´í„° ê³„ì‚° (ìŠ¹ì¸ì¼ ê¸°ì¤€!)
            let currentMonthSales = 0;
            let currentMonthCommission = 0;
            let currentMonthTax = 0;
            let currentMonthFinal = 0;
            let currentMonthApproved = 0;
            let currentMonthTotal = 0;

            // ëˆ„ì  ë°ì´í„° ê³„ì‚°
            let totalApproved = 0;

            myDbs.forEach(db => {
                const submittedDate = new Date(db.submittedAt);
                const isSubmittedThisMonth = submittedDate.getMonth() === currentMonth && submittedDate.getFullYear() === currentYear;

                if (db.status === 'ìŠ¹ì¸ë¨') {
                    totalApproved++;
                    
                    // ìŠ¹ì¸ì¼ ê¸°ì¤€ìœ¼ë¡œ ì´ë²ˆ ë‹¬ ë°ì´í„° ê³„ì‚°
                    if (db.approvedAt) {
                        const approvedDate = new Date(db.approvedAt);
                        const isApprovedThisMonth = approvedDate.getMonth() === currentMonth && approvedDate.getFullYear() === currentYear;
                        
                        if (isApprovedThisMonth) {
                            currentMonthApproved++;
                            currentMonthSales += (db.saleAmount || 0);
                            currentMonthCommission += (db.commission || 0);
                            currentMonthTax += (db.withholdingTax || 0);
                            currentMonthFinal += (db.finalAmount || 0);
                        }
                    }
                }

                if (isSubmittedThisMonth) {
                    currentMonthTotal++;
                }
            });

            // ì§€ê¸‰ ì˜ˆì •ì¼ í‘œì‹œ (ì´ë²ˆ ë‹¬ ìŠ¹ì¸ ê±´ì€ ë‹¤ìŒ ë‹¬ 10ì¼)
            const paymentDate = new Date(currentYear, currentMonth + 1, 10);
            const paymentDateStr = formatKoreanDate(paymentDate);
            document.getElementById('payment-date').textContent = `${paymentDateStr} (ìµì›” 10ì¼)`;

            // UI ì—…ë°ì´íŠ¸
            document.getElementById('current-month-sales').textContent = `â‚©${currentMonthSales.toLocaleString()}`;
            document.getElementById('current-month-commission').textContent = `â‚©${currentMonthCommission.toLocaleString()}`;
            document.getElementById('current-month-tax').textContent = `-â‚©${currentMonthTax.toLocaleString()}`;
            document.getElementById('current-month-final').textContent = `â‚©${currentMonthFinal.toLocaleString()}`;
            
            document.getElementById('current-month-db-count').textContent = `${currentMonthTotal} ê±´`;
            document.getElementById('current-month-db-detail').textContent = `(ìŠ¹ì¸ ${currentMonthApproved}ê±´)`;
            
            document.getElementById('total-db-count').textContent = `${myDbs.length} ê±´`;
            document.getElementById('total-db-detail').textContent = `(ìŠ¹ì¸ ${totalApproved}ê±´)`;

            renderDbList();
        }

        // ==================== DB ëª©ë¡ ë Œë”ë§ ====================
        function renderDbList() {
            const tbody = document.getElementById('db-list-tbody');
            tbody.innerHTML = '';

            if (myDbs.length === 0) {
                tbody.innerHTML = '<tr><td colspan="8" class="px-6 py-8 text-center text-gray-500">ì•„ì§ ìœ ì…ëœ DBê°€ ì—†ìŠµë‹ˆë‹¤.</td></tr>';
                return;
            }

            myDbs.forEach(db => {
                const row = document.createElement('tr');
                row.className = 'hover:bg-gray-50';
                
                const statusClass = db.status === 'ìŠ¹ì¸ë¨' ? 'bg-green-100 text-green-800' : 'bg-yellow-100 text-yellow-800';
                const statusText = db.status || 'ëŒ€ê¸°ì¤‘';
                
                const saleAmount = db.saleAmount ? `â‚©${parseInt(db.saleAmount).toLocaleString()}` : 'ë¯¸ì…ë ¥';
                const commission = db.commission ? `â‚©${parseInt(db.commission).toLocaleString()}` : 'â‚©0';
                const commissionRate = db.commissionRate ? `(${db.commissionRate}%)` : '';
                const withholdingTax = db.withholdingTax ? `â‚©${parseInt(db.withholdingTax).toLocaleString()}` : 'â‚©0';
                const finalAmount = db.finalAmount ? `â‚©${parseInt(db.finalAmount).toLocaleString()}` : 'â‚©0';
                
                // ì œì¶œ ì‹œê°„ - í•œêµ­ ì‹œê°„ìœ¼ë¡œ í¬ë§·
                const submittedAt = formatKoreanDateTime(db.submittedAt);
                
                // ì§€ê¸‰ ì˜ˆì •ì¼ ê³„ì‚° (ìŠ¹ì¸ì¼ ê¸°ì¤€ ë‹¤ìŒ ë‹¬ 10ì¼)
                let paymentDateStr = '-';
                if (db.approvedAt) {
                    const approvedDate = new Date(db.approvedAt);
                    const paymentDate = new Date(approvedDate.getFullYear(), approvedDate.getMonth() + 1, 10);
                    paymentDateStr = formatKoreanDate(paymentDate);
                }

                row.innerHTML = `
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${submittedAt}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${db.customerName || 'N/A'}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${saleAmount}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-blue-600 font-semibold">
                        ${commission}
                        <span class="text-xs text-gray-500">${commissionRate}</span>
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-red-600">${withholdingTax}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-green-600 font-bold">${finalAmount}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-indigo-600">${paymentDateStr}</td>
                    <td class="px-6 py-4 whitespace-nowrap">
                        <span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full ${statusClass}">
                            ${statusText}
                        </span>
                    </td>
                `;
                tbody.appendChild(row);
            });
        }

        // ==================== ì—ëŸ¬ í‘œì‹œ ====================
        function showError(message) {
            document.getElementById('error-text').textContent = message;
            document.getElementById('error-message').classList.remove('hidden');
        }
    </script>
</body>
</html>
