<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>íŒŒíŠ¸ë„ˆ ëŒ€ì‹œë³´ë“œ</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body { font-family: 'Inter', sans-serif; }
        .loader {
            border-top-color: #3498db;
            -webkit-animation: spin 1s linear infinite;
            animation: spin 1s linear infinite;
        }
        @-webkit-keyframes spin {
            0% { -webkit-transform: rotate(0deg); }
            100% { -webkit-transform: rotate(360deg); }
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body class="bg-gray-100">

    <!-- ìƒë‹¨ ë„¤ë¹„ê²Œì´ì…˜ -->
    <nav class="bg-white shadow-md">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex justify-between h-16">
                <div class="flex-shrink-0 flex items-center">
                    <h1 class="text-2xl font-bold text-indigo-600">Sales Dashboard</h1>
                </div>
                <div class="flex items-center">
                    <span id="user-welcome" class="text-sm text-gray-700 mr-4">ë¡œë”© ì¤‘...</span>
                    <button id="logout-button" class="bg-red-500 hover:bg-red-600 text-white px-3 py-1.5 rounded-md text-sm font-medium">
                        ë¡œê·¸ì•„ì›ƒ
                    </button>
                </div>
            </div>
        </div>
    </nav>

    <!-- ë©”ì¸ ì»¨í…ì¸  -->
    <div class="py-10">
        <header class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="md:flex md:items-center md:justify-between">
                <div class="flex-1 min-w-0">
                    <h2 id="user-name-header" class="text-3xl font-bold leading-7 text-gray-900 sm:text-4xl sm:truncate">
                        ...
                    </h2>
                    <p class="mt-1 text-lg text-gray-500">íŒŒíŠ¸ë„ˆë‹˜ì˜ ì‹¤ì ì„ í™•ì¸í•˜ì„¸ìš”.</p>
                </div>
                <div class="mt-4 flex md:mt-0 md:ml-4">
                    <div class="relative">
                        <input id="ref-link" type="text" readonly
                            class="bg-gray-200 text-gray-700 px-4 py-2 rounded-l-md focus:outline-none w-72"
                            value="https://brandforyou.kr/?ref=...">
                        <button id="copy-link-button" class="absolute right-0 top-0 h-full px-4 bg-indigo-600 text-white rounded-r-md hover:bg-indigo-700">
                            ë³µì‚¬
                        </button>
                    </div>
                </div>
            </div>
        </header>

        <main class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 mt-8">
            
            <!-- ë¡œë”© ìŠ¤í”¼ë„ˆ -->
            <div id="loading-spinner" class="flex justify-center items-center h-64">
                <div class="loader ease-linear rounded-full border-8 border-t-8 border-gray-200 h-32 w-32"></div>
            </div>

            <!-- ë°ì´í„° ì˜ì—­ (ë¡œë”© í›„ í‘œì‹œ) -->
            <div id="dashboard-content" class="hidden">
                <!-- 1. ìˆ˜ìµ í˜„í™© ì¹´ë“œ -->
                <h3 class="text-xl font-semibold text-gray-900 mb-4">ìˆ˜ìµ í˜„í™©</h3>
                <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                    <div class="bg-white p-6 rounded-xl shadow-lg">
                        <h4 class="text-sm font-medium text-gray-500">ì´ë²ˆ ë‹¬ ìŠ¹ì¸ ìˆ˜ìµ</h4>
                        <p id="this-month-commission" class="mt-1 text-4xl font-bold text-indigo-600">0 ì›</p>
                        <p id="month-comparison" class="mt-1 text-sm text-gray-500">ì§€ë‚œ ë‹¬ ëŒ€ë¹„ ...</p>
                    </div>
                    <div class="bg-white p-6 rounded-xl shadow-lg">
                        <h4 class="text-sm font-medium text-gray-500">ëˆ„ì  ì´ ìŠ¹ì¸ ìˆ˜ìµ</h4>
                        <p id="total-commission" class="mt-1 text-4xl font-bold text-gray-800">0 ì›</p>
                    </div>
                    <div class="bg-white p-6 rounded-xl shadow-lg">
                        <h4 class="text-sm font-medium text-gray-500">ì´ë²ˆ ë‹¬ ì´ DB ìœ ì…</h4>
                        <p id="this-month-dbs" class="mt-1 text-4xl font-bold text-gray-800">0 ê±´</p>
                        <p id="total-dbs" class="mt-1 text-sm text-gray-500"> (ëˆ„ì  0 ê±´)</p>
                    </div>
                </div>

                <!-- 2. ë‚´ DB í™•ì¸í•˜ê¸° -->
                <h3 class="text-xl font-semibold text-gray-900 mt-10 mb-4">ë‚´ DB ëª©ë¡ (ìµœì‹ ìˆœ)</h3>
                <div class="bg-white shadow-lg rounded-xl overflow-hidden">
                    <table class="min-w-full divide-y divide-gray-200">
                        <thead class="bg-gray-50">
                            <tr>
                                <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">ì œì¶œ ì‹œê°„</th>
                                <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">ê³ ê° ì„±í•¨</th>
                                <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">ìŠ¹ì¸ ìƒíƒœ</th>
                                <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">ìˆ˜ìµê¸ˆ</th>
                            </tr>
                        </thead>
                        <tbody id="db-table-body" class="bg-white divide-y divide-gray-200">
                            <!-- JSë¡œ ë°ì´í„°ê°€ ì±„ì›Œì§ˆ ì˜ì—­ -->
                            <tr>
                                <td colspan="4" class="px-6 py-4 text-center text-gray-500">DBë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ì…ë‹ˆë‹¤...</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </main>
    </div>

    <!-- Firebase SDK -->
    <script type="module">
        // 1. Firebase SDK import
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
        import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
        import { getFirestore, doc, getDoc } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

        // 2. ì‚¬ì¥ë‹˜ì˜ Firebase ì„¤ì • ì •ë³´
        const firebaseConfig = {
            apiKey: "AIzaSyA7eBsXhWAZBvaus9aovVf0GQeMEzvr1R4",
            authDomain: "speedlanding-dc186.firebaseapp.com",
            projectId: "speedlanding-dc186",
            storageBucket: "speedlanding-dc186.firebasestorage.app",
            messagingSenderId: "392587509521",
            appId: "1:392587509521:web:2679d3da4f9bb2e23156b0",
            measurementId: "G-ZG0N9R3LGF"
        };
        
        // (!!!!) [ì—…ë°ì´íŠ¸ë¨] ì‚¬ì¥ë‹˜ì´ ë°°í¬í•œ Google Apps Script URL
        const GAS_URL = "https://script.google.com/macros/s/AKfycbx3cbyR4IxuwtD9UsUUt26FwEUDc702s2ikBGQIz0T2WeKiVKLncKsRueVHSbVrqrTX/exec";


        // 3. Firebase ì•± ì´ˆê¸°í™”
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        // 4. DOM ìš”ì†Œ
        const loadingSpinner = document.getElementById('loading-spinner');
        const dashboardContent = document.getElementById('dashboard-content');
        const logoutButton = document.getElementById('logout-button');
        const copyLinkButton = document.getElementById('copy-link-button');

        // 5. ë©”ì¸ ë¡œì§: ì¸ì¦ ìƒíƒœ í™•ì¸
        onAuthStateChanged(auth, async (user) => {
            if (user) {
                // ë¡œê·¸ì¸ëœ ìƒíƒœ
                try {
                    // 1. Firestoreì—ì„œ ì˜ì—…ì ì •ë³´ ê°€ì ¸ì˜¤ê¸°
                    const userData = await getUserData(user.uid);
                    if (!userData) {
                        throw new Error("Firestoreì—ì„œ ì‚¬ìš©ì ì •ë³´ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.");
                    }
                    
                    // 2. í—¤ë” ë° ì˜ì—… ë§í¬ UI ì—…ë°ì´íŠ¸
                    updateHeaderUI(userData);

                    // 3. Google Apps Scriptì—ì„œ DB ë°ì´í„° ê°€ì ¸ì˜¤ê¸°
                    const dbData = await fetchSheetData(userData.username);

                    // 4. ë°ì´í„° ë¶„ì„ ë° ëŒ€ì‹œë³´ë“œ UI ì—…ë°ì´íŠ¸
                    updateDashboardUI(dbData);
                    updateDbTable(dbData);

                    // 5. ë¡œë”© ìˆ¨ê¸°ê³  ì»¨í…ì¸  í‘œì‹œ
                    loadingSpinner.classList.add('hidden');
                    dashboardContent.classList.remove('hidden');

                } catch (error) {
                    console.error("ëŒ€ì‹œë³´ë“œ ë¡œë”© ì‹¤íŒ¨:", error);
                    document.body.innerHTML = `<div class="p-8 text-red-500">ëŒ€ì‹œë³´ë“œ ë¡œë”©ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤: ${error.message}</div>`;
                }
            } else {
                // ë¡œê·¸ì•„ì›ƒëœ ìƒíƒœ -> ë¡œê·¸ì¸ í˜ì´ì§€ë¡œ ë¦¬ë””ë ‰ì…˜
                // [FIX] ìƒëŒ€ ê²½ë¡œ ëŒ€ì‹  'window.location.origin'ì„ ì‚¬ìš©í•˜ì—¬ ì ˆëŒ€ ê²½ë¡œë¡œ ë³€ê²½
                // ì´ë ‡ê²Œ í•˜ë©´ '.../index.html' í˜•íƒœì˜ ìœ íš¨í•œ URLì´ ë©ë‹ˆë‹¤.
                window.location.href = window.location.origin + '/index.html';
            }
        });

        // 6. Firestoreì—ì„œ ì˜ì—…ì ìƒì„¸ ì •ë³´ ê°€ì ¸ì˜¤ê¸°
        async function getUserData(uid) {
            const docRef = doc(db, "users", uid);
            const docSnap = await getDoc(docRef);
            if (docSnap.exists()) {
                return docSnap.data();
            } else {
                return null;
            }
        }

        // 7. Google Apps Script(GAS)ì—ì„œ DB ëª©ë¡ ê°€ì ¸ì˜¤ê¸°
        async function fetchSheetData(referralCode) {
            const url = new URL(GAS_URL);
            url.searchParams.append('action', 'getDbsByRef');
            url.searchParams.append('ref', referralCode);

            // API í˜¸ì¶œ ì‹œ ìºì‹œë¥¼ ì‚¬ìš©í•˜ì§€ ì•Šë„ë¡ ì„¤ì • (ì‹¤ì‹œê°„ ë°˜ì˜)
            const response = await fetch(url, { cache: 'no-store' });
            if (!response.ok) {
                throw new Error("Apps Script API í˜¸ì¶œì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.");
            }
            const result = await response.json();
            if (!result.success) {
                throw new Error(`Apps Script ì˜¤ë¥˜: ${result.message}`);
            }
            return result.data; // DB ë°ì´í„° ë°°ì—´ ë°˜í™˜
        }

        // 8. í—¤ë” UI ì—…ë°ì´íŠ¸ (ì´ë¦„, ì˜ì—…ë§í¬)
        function updateHeaderUI(userData) {
            document.getElementById('user-welcome').textContent = `${userData.fullName || 'íŒŒíŠ¸ë„ˆ'}ë‹˜, í™˜ì˜í•©ë‹ˆë‹¤!`;
            document.getElementById('user-name-header').textContent = `${userData.fullName || '...'}ë‹˜ì˜ ëŒ€ì‹œë³´ë“œ`;
            const refLinkInput = document.getElementById('ref-link');
            refLinkInput.value = `https://brandforyou.kr/?ref=${userData.username}`;
        }

        // 9. ëŒ€ì‹œë³´ë“œ ì¹´ë“œ (ìˆ˜ìµ í˜„í™©) UI ì—…ë°ì´íŠ¸
        function updateDashboardUI(dbData) {
            const now = new Date();
            const currentYear = now.getFullYear();
            const currentMonth = now.getMonth(); // 0 (1ì›”) ~ 11 (12ì›”)

            let totalCommission = 0;
            let thisMonthCommission = 0;
            let lastMonthCommission = 0;
            let thisMonthDbs = 0;

            dbData.forEach(db => {
                const dbDate = new Date(db.submittedAt);
                const dbYear = dbDate.getFullYear();
                const dbMonth = dbDate.getMonth();

                // ëˆ„ì  ì´ ìˆ˜ìµ (ìŠ¹ì¸ëœ ê²ƒë§Œ)
                if (db.status === 'ìŠ¹ì¸ë¨') {
                    totalCommission += db.commission;
                }

                // ì´ë²ˆ ë‹¬ ë°ì´í„°
                if (dbYear === currentYear && dbMonth === currentMonth) {
                    thisMonthDbs++;
                    if (db.status === 'ìŠ¹ì¸ë¨') {
                        thisMonthCommission += db.commission;
                    }
                }
                
                // ì§€ë‚œ ë‹¬ ë°ì´í„°
                const lastMonthDate = new Date(now.getFullYear(), now.getMonth() - 1, 1);
                if (dbYear === lastMonthDate.getFullYear() && dbMonth === lastMonthDate.getMonth()) {
                    if (db.status === 'ìŠ¹ì¸ë¨') {
                        lastMonthCommission += db.commission;
                    }
                }
            });

            // ìˆ«ì í¬ë§·íŒ… (ì›)
            const formatter = new Intl.NumberFormat('ko-KR', { style: 'currency', currency: 'KRW' });
            
            document.getElementById('this-month-commission').textContent = formatter.format(thisMonthCommission);
            document.getElementById('total-commission').textContent = formatter.format(totalCommission);
            document.getElementById('this-month-dbs').textContent = `${thisMonthDbs} ê±´`;
            document.getElementById('total-dbs').textContent = ` (ëˆ„ì  ${dbData.length} ê±´)`;

            // ì§€ë‚œ ë‹¬ ëŒ€ë¹„ % ê³„ì‚°
            const comparisonEl = document.getElementById('month-comparison');
            if (lastMonthCommission === 0) {
                if (thisMonthCommission > 0) {
                    comparisonEl.textContent = 'ì§€ë‚œ ë‹¬ ì‹¤ì  ì—†ìŒ';
                } else {
                    comparisonEl.textContent = 'ì§€ë‚œ ë‹¬ ì‹¤ì  ì—†ìŒ';
                }
                comparisonEl.className = 'mt-1 text-sm text-gray-500';
            } else {
                const percentChange = ((thisMonthCommission - lastMonthCommission) / lastMonthCommission) * 100;
                if (percentChange > 0) {
                    comparisonEl.textContent = `ì§€ë‚œ ë‹¬ ëŒ€ë¹„ ${percentChange.toFixed(0)}% ì¦ê°€ ğŸ”º`;
                    comparisonEl.className = 'mt-1 text-sm text-green-600';
                } else if (percentChange < 0) {
                    comparisonEl.textContent = `ì§€ë‚œ ë‹¬ ëŒ€ë¹„ ${Math.abs(percentChange).toFixed(0)}% ê°ì†Œ ğŸ”»`;
                    comparisonEl.className = 'mt-1 text-sm text-red-600';
                } else {
                    comparisonEl.textContent = `ì§€ë‚œ ë‹¬ê³¼ ë™ì¼í•©ë‹ˆë‹¤.`;
                    comparisonEl.className = 'mt-1 text-sm text-gray-500';
                }
            }
        }

        // 10. DB ëª©ë¡ í…Œì´ë¸” UI ì—…ë°ì´íŠ¸
        function updateDbTable(dbData) {
            const tableBody = document.getElementById('db-table-body');
            tableBody.innerHTML = ''; // ê¸°ì¡´ ë‚´ìš© ë¹„ìš°ê¸°

            if (dbData.length === 0) {
                tableBody.innerHTML = `<tr><td colspan="4" class="px-6 py-4 text-center text-gray-500">ì•„ì§ ìœ ì…ëœ DBê°€ ì—†ìŠµë‹ˆë‹¤.</td></tr>`;
                return;
            }
            
            const formatter = new Intl.NumberFormat('ko-KR', { style: 'currency', currency: 'KRW' });

            dbData.forEach(db => {
                let statusBadge = '';
                if (db.status === 'ìŠ¹ì¸ë¨') {
                    statusBadge = `<span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full bg-green-100 text-green-800">ìŠ¹ì¸ë¨</span>`;
                } else if (db.status === 'ëŒ€ê¸°' || !db.status) {
                    statusBadge = `<span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full bg-yellow-100 text-yellow-800">ëŒ€ê¸°ì¤‘</span>`;
                } else {
                    statusBadge = `<span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full bg-gray-100 text-gray-800">${db.status}</span>`;
                }


                const row = `
                    <tr>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-700">${new Date(db.submittedAt).toLocaleString('ko-KR')}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-700">${db.customerName || 'N/A'}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm">${statusBadge}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-800 font-medium">${db.status === 'ìŠ¹ì¸ë¨' ? formatter.format(db.commission) : '-'}</td>
                    </tr>
                `;
                tableBody.innerHTML += row; // í…Œì´ë¸”ì— í–‰ ì¶”ê°€
            });
        }

        // 11. ë¡œê·¸ì•„ì›ƒ ì´ë²¤íŠ¸
        logoutButton.addEventListener('click', async () => {
            try {
                await signOut(auth);
                // onAuthStateChanged ë¦¬ìŠ¤ë„ˆê°€ ê°ì§€í•˜ì—¬ ìë™ìœ¼ë¡œ ë¡œê·¸ì¸ í˜ì´ì§€ë¡œ ì´ë™ì‹œí‚µë‹ˆë‹¤.
            } catch (error) {
                console.error("ë¡œê·¸ì•„ì›ƒ ì‹¤íŒ¨:", error);
            }
        });

        // 12. ì˜ì—… ë§í¬ ë³µì‚¬ ì´ë²¤íŠ¸
        copyLinkButton.addEventListener('click', () => {
            const refLinkInput = document.getElementById('ref-link');
            
            // navigator.clipboard.writeTextê°€ ìµœì‹  ë°©ì‹ì´ë©° https í™˜ê²½ì—ì„œ ì˜ ì‘ë™í•©ë‹ˆë‹¤.
            // iFrameì´ ì•„ë‹Œ ì‹¤ì œ Netlify ë°°í¬ í™˜ê²½ì—ì„œëŠ” ì´ ë°©ì‹ì´ ë” ì•ˆì •ì ì…ë‹ˆë‹¤.
            navigator.clipboard.writeText(refLinkInput.value).then(() => {
                copyLinkButton.textContent = 'ë³µì‚¬ë¨!';
                setTimeout(() => {
                    copyLinkButton.textContent = 'ë³µì‚¬';
                }, 2000);
            }).catch(err => {
                console.error('ë§í¬ ë³µì‚¬ ì‹¤íŒ¨:', err);
                // í´ë¦½ë³´ë“œ ë³µì‚¬ ì‹¤íŒ¨ ì‹œ (ì˜ˆ: http í™˜ê²½) êµ¬ ë°©ì‹(execCommand) ì‹œë„
                try {
                    refLinkInput.select();
                    document.execCommand('copy');
                    copyLinkButton.textContent = 'ë³µì‚¬ë¨!';
                    setTimeout(() => {
                        copyLinkButton.textContent = 'ë³µì‚¬';
                    }, 2000);
                } catch (e) {
                    alert('ë§í¬ ë³µì‚¬ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤. ì§ì ‘ ë³µì‚¬í•´ ì£¼ì„¸ìš”.');
                }
            });
        });

    </script>
</body>
</html>

