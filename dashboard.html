<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sales Dashboard</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore-compat.js"></script>
    <style>
        body { font-family: 'Inter', sans-serif; }
        .loader {
            border-top-color: #3498db;
            -webkit-animation: spin 1s linear infinite;
            animation: spin 1s linear infinite;
        }
        @-webkit-keyframes spin {
            0% { -webkit-transform: rotate(0deg); }
            100% { -webkit-transform: rotate(360deg); }
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        .tab-button {
            padding: 12px 24px;
            font-weight: 500;
            border-bottom: 2px solid transparent;
            transition: all 0.3s;
        }
        .tab-button.active {
            color: #4F46E5;
            border-bottom-color: #4F46E5;
        }
        .tab-content {
            display: none;
        }
        .tab-content.active {
            display: block;
        }
    </style>
</head>
<body class="bg-gray-100 min-h-screen">

    <nav class="bg-white shadow-sm">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex justify-between h-16">
                <div class="flex-shrink-0 flex items-center">
                    <h1 class="text-2xl font-bold text-indigo-600">Sales Dashboard</h1>
                </div>
                <div id="nav-user" class="flex items-center hidden">
                    <span id="user-email" class="text-sm text-gray-700 mr-4"></span>
                    <button id="logout-button" class="bg-red-500 hover:bg-red-600 text-white px-3 py-1.5 rounded-md text-sm font-medium">
                        ë¡œê·¸ì•„ì›ƒ
                    </button>
                </div>
            </div>
        </div>
    </nav>

    <div id="main-container" class="py-10 max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
        
        <div id="loading-spinner" class="flex justify-center items-center h-[70vh]">
            <div class="flex flex-col items-center">
                <div class="loader ease-linear rounded-full border-8 border-t-8 border-gray-200 h-24 w-24 mb-4"></div>
                <h2 class="text-xl font-semibold text-gray-600">ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ì…ë‹ˆë‹¤...</h2>
            </div>
        </div>
        
        <div id="dashboard-content" class="hidden">
            <div id="error-message" class="hidden bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded-lg relative mb-6" role="alert">
                <strong class="font-bold">ë°ì´í„° ë¡œë“œ ì‹¤íŒ¨:</strong>
                <span id="error-text" class="block sm:inline"></span>
            </div>

            <div id="success-message" class="hidden bg-green-100 border border-green-400 text-green-700 px-4 py-3 rounded-lg relative mb-6" role="alert">
                <span id="success-text" class="block sm:inline"></span>
            </div>

            <!-- íƒ­ ë²„íŠ¼ -->
            <div class="bg-white shadow-sm rounded-t-xl mb-0">
                <div class="border-b border-gray-200">
                    <nav class="flex space-x-8 px-6" aria-label="Tabs">
                        <button class="tab-button active" data-tab="dashboard">ğŸ“Š ëŒ€ì‹œë³´ë“œ</button>
                        <button class="tab-button" data-tab="profile">ğŸ‘¤ ë‚´ ì •ë³´</button>
                    </nav>
                </div>
            </div>

            <!-- ëŒ€ì‹œë³´ë“œ íƒ­ -->
            <div id="dashboard-tab" class="tab-content active bg-white shadow-lg rounded-b-xl p-6">
                <header class="mb-8 md:flex md:items-center md:justify-between">
                    <div>
                        <h2 id="welcome-title" class="text-3xl font-bold leading-7 text-gray-900 sm:text-4xl sm:truncate">
                            íŒŒíŠ¸ë„ˆë‹˜ì˜ ëŒ€ì‹œë³´ë“œ
                        </h2>
                        <p class="mt-1 text-lg text-gray-500">íŒŒíŠ¸ë„ˆë‹˜ì˜ ì‹¤ì ì„ í™•ì¸í•˜ì„¸ìš”.</p>
                    </div>
                    <div class="mt-4 md:mt-0 md:ml-4 flex-shrink-0">
                        <label for="ref-link" class="block text-sm font-medium text-gray-700">ë‚´ ì˜ì—… ë§í¬</label>
                        <div class="mt-1 flex rounded-md shadow-sm">
                            <input type="text" id="ref-link" readonly class="focus:ring-indigo-500 focus:border-indigo-500 flex-1 block w-full rounded-none rounded-l-md sm:text-sm border-gray-300 bg-gray-50 p-2">
                            <button id="copy-link-button" type="button" class="-ml-px relative inline-flex items-center space-x-2 px-4 py-2 border border-gray-300 text-sm font-medium rounded-r-md text-gray-700 bg-gray-50 hover:bg-gray-100 focus:outline-none">
                                <span>ë³µì‚¬</span>
                            </button>
                        </div>
                    </div>
                </header>

                <!-- ê²½ê³  ë©”ì‹œì§€ (ì •ë³´ ë¯¸ì…ë ¥ ì‹œ) -->
                <div id="profile-warning" class="hidden bg-yellow-50 border-l-4 border-yellow-400 p-4 mb-6">
                    <div class="flex">
                        <div class="flex-shrink-0">
                            <svg class="h-5 w-5 text-yellow-400" viewBox="0 0 20 20" fill="currentColor">
                                <path fill-rule="evenodd" d="M8.257 3.099c.765-1.36 2.722-1.36 3.486 0l5.58 9.92c.75 1.334-.213 2.98-1.742 2.98H4.42c-1.53 0-2.493-1.646-1.743-2.98l5.58-9.92zM11 13a1 1 0 11-2 0 1 1 0 012 0zm-1-8a1 1 0 00-1 1v3a1 1 0 002 0V6a1 1 0 00-1-1z" clip-rule="evenodd" />
                            </svg>
                        </div>
                        <div class="ml-3">
                            <p class="text-sm text-yellow-700">
                                ì •ì‚°ì„ ë°›ìœ¼ë ¤ë©´ <strong>"ë‚´ ì •ë³´"</strong> íƒ­ì—ì„œ ì´ë¦„, ì—°ë½ì²˜, ê³„ì¢Œ ì •ë³´ë¥¼ ë“±ë¡í•´ì£¼ì„¸ìš”!
                            </p>
                        </div>
                    </div>
                </div>

                <!-- ìˆ˜ìµ í˜„í™© (4ê°œ ì¹´ë“œ) -->
                <section class="mb-10">
                    <h3 class="text-2xl font-semibold text-gray-900 mb-2">ì´ë²ˆ ë‹¬ ìˆ˜ìµ í˜„í™©</h3>
                    <p class="text-sm text-gray-600 mb-4">ì§€ê¸‰ ì˜ˆì •ì¼: <span id="payment-date" class="font-semibold text-indigo-600">ìµì›” 10ì¼</span></p>
                    <div class="grid grid-cols-1 md:grid-cols-4 gap-6">
                        <div class="bg-white shadow-lg rounded-xl p-6">
                            <h4 class="text-sm font-medium text-gray-500">ì´ íŒë§¤ì•¡</h4>
                            <p id="current-month-sales" class="mt-2 text-3xl font-bold text-gray-900">â‚©0</p>
                        </div>
                        <div class="bg-white shadow-lg rounded-xl p-6">
                            <h4 class="text-sm font-medium text-gray-500">ì´ ìˆ˜ìµê¸ˆ</h4>
                            <p id="current-month-commission" class="mt-2 text-3xl font-bold text-blue-600">â‚©0</p>
                            <p class="text-xs text-gray-500 mt-1">ì›ì²œì§•ìˆ˜ ì „</p>
                        </div>
                        <div class="bg-white shadow-lg rounded-xl p-6">
                            <h4 class="text-sm font-medium text-gray-500">ì›ì²œì§•ìˆ˜ í•©ê³„</h4>
                            <p id="current-month-tax" class="mt-2 text-3xl font-bold text-red-600">â‚©0</p>
                            <p class="text-xs text-gray-500 mt-1">3.3%</p>
                        </div>
                        <div class="bg-white shadow-lg rounded-xl p-6">
                            <h4 class="text-sm font-medium text-gray-500">ìµœì¢… ì •ì‚° ì˜ˆì •ì•¡</h4>
                            <p id="current-month-final" class="mt-2 text-3xl font-bold text-green-600">â‚©0</p>
                        </div>
                    </div>
                </section>

                <!-- DB ìœ ì… í˜„í™© -->
                <section class="mb-10">
                    <h3 class="text-2xl font-semibold text-gray-900 mb-4">DB ìœ ì… í˜„í™©</h3>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <div class="bg-white shadow-lg rounded-xl p-6">
                            <h4 class="text-sm font-medium text-gray-500">ì´ë²ˆ ë‹¬ ì´ DB ìœ ì…</h4>
                            <p id="current-month-db-count" class="mt-2 text-4xl font-bold text-gray-900">0 ê±´</p>
                            <p id="current-month-db-detail" class="mt-1 text-sm text-gray-500">(ìŠ¹ì¸ 0ê±´)</p>
                        </div>
                        <div class="bg-white shadow-lg rounded-xl p-6">
                            <h4 class="text-sm font-medium text-gray-500">ëˆ„ì  ì´ DB ìœ ì…</h4>
                            <p id="total-db-count" class="mt-2 text-4xl font-bold text-gray-900">0 ê±´</p>
                            <p id="total-db-detail" class="mt-1 text-sm text-gray-500">(ìŠ¹ì¸ 0ê±´)</p>
                        </div>
                    </div>
                </section>

                <!-- DB ëª©ë¡ -->
                <section>
                    <h3 class="text-2xl font-semibold text-gray-900 mb-4">ë‚´ DB ëª©ë¡ (ìµœì‹ ìˆœ)</h3>
                    <div class="bg-white shadow-lg rounded-xl overflow-hidden">
                        <div class="overflow-x-auto">
                            <table class="min-w-full divide-y divide-gray-200">
                                <thead class="bg-gray-50">
                                    <tr>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">ì œì¶œ ì‹œê°„</th>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">ê³ ê° ì„±í•¨</th>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">íŒë§¤ê¸ˆì•¡</th>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">ìˆ˜ìµê¸ˆ</th>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">ì›ì²œì§•ìˆ˜</th>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">ì •ì‚°ì˜ˆì •ì•¡</th>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">ì§€ê¸‰ì˜ˆì •ì¼</th>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">ìƒíƒœ</th>
                                    </tr>
                                </thead>
                                <tbody id="db-list-tbody" class="bg-white divide-y divide-gray-200">
                                    <tr>
                                        <td colspan="8" class="px-6 py-8 text-center text-gray-500">ì•„ì§ ìœ ì…ëœ DBê°€ ì—†ìŠµë‹ˆë‹¤.</td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </section>
            </div>

            <!-- ë‚´ ì •ë³´ íƒ­ -->
            <div id="profile-tab" class="tab-content bg-white shadow-lg rounded-b-xl p-6">
                <h2 class="text-2xl font-bold text-gray-900 mb-6">ë‚´ ì •ë³´</h2>
                
                <div class="max-w-2xl">
                    <!-- ê¸°ë³¸ ì •ë³´ -->
                    <div class="mb-8">
                        <h3 class="text-lg font-semibold text-gray-900 mb-4 flex items-center">
                            <svg class="w-5 h-5 mr-2 text-indigo-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"></path>
                            </svg>
                            ê¸°ë³¸ ì •ë³´
                        </h3>
                        <div class="space-y-4">
                            <div>
                                <label for="fullName" class="block text-sm font-medium text-gray-700 mb-2">ì´ë¦„ (ì‹¤ëª…) *</label>
                                <input type="text" id="fullName" 
                                       class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500"
                                       placeholder="í™ê¸¸ë™">
                            </div>
                            <div>
                                <label for="phoneNumber" class="block text-sm font-medium text-gray-700 mb-2">ì—°ë½ì²˜ *</label>
                                <input type="tel" id="phoneNumber" 
                                       class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500"
                                       placeholder="010-1234-5678">
                            </div>
                        </div>
                    </div>

                    <!-- ì •ì‚° ê³„ì¢Œ ì •ë³´ -->
                    <div class="mb-8">
                        <h3 class="text-lg font-semibold text-gray-900 mb-4 flex items-center">
                            <svg class="w-5 h-5 mr-2 text-green-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 10h18M7 15h1m4 0h1m-7 4h12a3 3 0 003-3V8a3 3 0 00-3-3H6a3 3 0 00-3 3v8a3 3 0 003 3z"></path>
                            </svg>
                            ì •ì‚° ê³„ì¢Œ ì •ë³´
                        </h3>
                        <div class="space-y-4">
                            <div>
                                <label for="bankName" class="block text-sm font-medium text-gray-700 mb-2">ì€í–‰ëª… *</label>
                                <select id="bankName" 
                                        class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500">
                                    <option value="">ì€í–‰ ì„ íƒ</option>
                                    <option value="KBêµ­ë¯¼ì€í–‰">KBêµ­ë¯¼ì€í–‰</option>
                                    <option value="ì‹ í•œì€í–‰">ì‹ í•œì€í–‰</option>
                                    <option value="ìš°ë¦¬ì€í–‰">ìš°ë¦¬ì€í–‰</option>
                                    <option value="í•˜ë‚˜ì€í–‰">í•˜ë‚˜ì€í–‰</option>
                                    <option value="NHë†í˜‘ì€í–‰">NHë†í˜‘ì€í–‰</option>
                                    <option value="IBKê¸°ì—…ì€í–‰">IBKê¸°ì—…ì€í–‰</option>
                                    <option value="SCì œì¼ì€í–‰">SCì œì¼ì€í–‰</option>
                                    <option value="ì¹´ì¹´ì˜¤ë±…í¬">ì¹´ì¹´ì˜¤ë±…í¬</option>
                                    <option value="í† ìŠ¤ë±…í¬">í† ìŠ¤ë±…í¬</option>
                                    <option value="ì¼€ì´ë±…í¬">ì¼€ì´ë±…í¬</option>
                                    <option value="ìƒˆë§ˆì„ê¸ˆê³ ">ìƒˆë§ˆì„ê¸ˆê³ </option>
                                    <option value="ì‹ í˜‘">ì‹ í˜‘</option>
                                    <option value="ìš°ì²´êµ­">ìš°ì²´êµ­</option>
                                    <option value="ë¶€ì‚°ì€í–‰">ë¶€ì‚°ì€í–‰</option>
                                    <option value="ëŒ€êµ¬ì€í–‰">ëŒ€êµ¬ì€í–‰</option>
                                    <option value="ê²½ë‚¨ì€í–‰">ê²½ë‚¨ì€í–‰</option>
                                    <option value="ê´‘ì£¼ì€í–‰">ê´‘ì£¼ì€í–‰</option>
                                    <option value="ì „ë¶ì€í–‰">ì „ë¶ì€í–‰</option>
                                    <option value="ì œì£¼ì€í–‰">ì œì£¼ì€í–‰</option>
                                </select>
                            </div>
                            <div>
                                <label for="accountNumber" class="block text-sm font-medium text-gray-700 mb-2">ê³„ì¢Œë²ˆí˜¸ *</label>
                                <input type="text" id="accountNumber" 
                                       class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500"
                                       placeholder="123456-78-901234">
                                <p class="mt-1 text-xs text-gray-500">"-" í¬í•¨í•´ì„œ ì…ë ¥í•´ì£¼ì„¸ìš”</p>
                            </div>
                            <div>
                                <label for="accountHolder" class="block text-sm font-medium text-gray-700 mb-2">ì˜ˆê¸ˆì£¼ëª… *</label>
                                <input type="text" id="accountHolder" 
                                       class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500"
                                       placeholder="í™ê¸¸ë™">
                                <p class="mt-1 text-xs text-gray-500">ê³„ì¢Œì˜ ì‹¤ì œ ì˜ˆê¸ˆì£¼ëª…ì„ ì…ë ¥í•´ì£¼ì„¸ìš”</p>
                            </div>
                        </div>
                    </div>

                    <div class="flex justify-end">
                        <button id="save-profile-btn" 
                                class="bg-indigo-600 hover:bg-indigo-700 text-white px-6 py-3 rounded-lg font-medium transition">
                            ğŸ’¾ ì €ì¥í•˜ê¸°
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // ==================== ì„¤ì • ====================
        
        const firebaseConfig = {
          apiKey: "AIzaSyA7eBsXhWAZBvaus9aovVf0GQeMEzvr1R4",
          authDomain: "speedlanding-dc186.firebaseapp.com",
          projectId: "speedlanding-dc186",
          storageBucket: "speedlanding-dc186.firebasestorage.app",
          messagingSenderId: "392587509521",
          appId: "1:392587509521:web:2679d3da4f9bb2e23156b0",
          measurementId: "G-ZG0N9R3LGF"
        };
        
        const GAS_URL = "/.netlify/functions/sheets-proxy";
        const BASE_URL = "https://brandforyou.kr";

        try {
          firebase.initializeApp(firebaseConfig);
        } catch (error) {
          console.error("Firebase ì´ˆê¸°í™” ì˜¤ë¥˜:", error);
        }

        const auth = firebase.auth();
        const db = firebase.firestore();

        let currentUser = null;
        let myDbs = [];
        let myReferralCode = null;
        let userProfile = {};

        // ==================== íƒ­ ì „í™˜ ====================
        document.querySelectorAll('.tab-button').forEach(button => {
            button.addEventListener('click', () => {
                const tabName = button.getAttribute('data-tab');
                
                // íƒ­ ë²„íŠ¼ í™œì„±í™”
                document.querySelectorAll('.tab-button').forEach(btn => btn.classList.remove('active'));
                button.classList.add('active');
                
                // íƒ­ ì»¨í…ì¸  í‘œì‹œ
                document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
                document.getElementById(`${tabName}-tab`).classList.add('active');
            });
        });

        // ==================== í•œêµ­ ì‹œê°„ í¬ë§·íŒ… ====================
        function formatKoreanDateTime(dateString) {
            if (!dateString) return 'N/A';
            
            try {
                const date = new Date(dateString);
                
                return date.toLocaleString('ko-KR', { 
                    timeZone: 'Asia/Seoul',
                    year: 'numeric',
                    month: '2-digit',
                    day: '2-digit',
                    hour: '2-digit',
                    minute: '2-digit',
                    hour12: false
                }).replace(/\. /g, '-').replace('.', '');
            } catch (error) {
                console.error('ë‚ ì§œ í¬ë§· ì˜¤ë¥˜:', error);
                return dateString;
            }
        }

        function formatKoreanDate(dateString) {
            if (!dateString) return '-';
            
            try {
                const date = new Date(dateString);
                
                return date.toLocaleDateString('ko-KR', { 
                    timeZone: 'Asia/Seoul',
                    year: 'numeric',
                    month: '2-digit',
                    day: '2-digit'
                }).replace(/\. /g, '-').replace('.', '');
            } catch (error) {
                console.error('ë‚ ì§œ í¬ë§· ì˜¤ë¥˜:', error);
                return dateString;
            }
        }

        // ==================== ë¡œê·¸ì¸ ì²´í¬ ====================
        auth.onAuthStateChanged(async (user) => {
            if (user) {
                currentUser = user;
                document.getElementById('user-email').textContent = user.email;
                document.getElementById('nav-user').classList.remove('hidden');
                
                try {
                    const doc = await db.collection('users').doc(user.uid).get();
                    if (doc.exists) {
                        const data = doc.data();
                        myReferralCode = data.referralCode;
                        userProfile = data;
                        
                        if (!myReferralCode) {
                            showError('referralCodeê°€ ì„¤ì •ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.');
                            return;
                        }
                        
                        document.getElementById('ref-link').value = `${BASE_URL}?ref=${myReferralCode}`;
                        
                        // í”„ë¡œí•„ ì •ë³´ ë¡œë“œ
                        loadProfileData(data);
                        
                        // í”„ë¡œí•„ ì™„ì„±ë„ ì²´í¬
                        checkProfileComplete(data);
                        
                        await loadMyDbs();
                    } else {
                        showError('ì‚¬ìš©ì ì •ë³´ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
                    }
                } catch (error) {
                    console.error('ì‚¬ìš©ì ì •ë³´ ë¡œë“œ ì‹¤íŒ¨:', error);
                    showError('ì‚¬ìš©ì ì •ë³´ë¥¼ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
                }
            } else {
                window.location.href = "index.html";
            }
        });

        // ==================== í”„ë¡œí•„ ì •ë³´ ë¡œë“œ ====================
        function loadProfileData(data) {
            document.getElementById('fullName').value = data.fullName || '';
            document.getElementById('phoneNumber').value = data.phoneNumber || '';
            document.getElementById('bankName').value = data.bankName || '';
            document.getElementById('accountNumber').value = data.accountNumber || '';
            document.getElementById('accountHolder').value = data.accountHolder || '';
        }

        // ==================== í”„ë¡œí•„ ì™„ì„±ë„ ì²´í¬ ====================
        function checkProfileComplete(data) {
            const isComplete = data.fullName && data.phoneNumber && 
                             data.bankName && data.accountNumber && data.accountHolder;
            
            if (!isComplete) {
                document.getElementById('profile-warning').classList.remove('hidden');
            } else {
                document.getElementById('profile-warning').classList.add('hidden');
            }
        }

        // ==================== í”„ë¡œí•„ ì €ì¥ ====================
        document.getElementById('save-profile-btn').addEventListener('click', async () => {
            const fullName = document.getElementById('fullName').value.trim();
            const phoneNumber = document.getElementById('phoneNumber').value.trim();
            const bankName = document.getElementById('bankName').value;
            const accountNumber = document.getElementById('accountNumber').value.trim();
            const accountHolder = document.getElementById('accountHolder').value.trim();

            // ìœ íš¨ì„± ê²€ì‚¬
            if (!fullName) {
                alert('ì´ë¦„ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.');
                return;
            }

            if (!phoneNumber) {
                alert('ì—°ë½ì²˜ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.');
                return;
            }

            if (!bankName) {
                alert('ì€í–‰ì„ ì„ íƒí•´ì£¼ì„¸ìš”.');
                return;
            }

            if (!accountNumber) {
                alert('ê³„ì¢Œë²ˆí˜¸ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.');
                return;
            }

            if (!accountHolder) {
                alert('ì˜ˆê¸ˆì£¼ëª…ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.');
                return;
            }

            try {
                // Firestoreì— ì €ì¥
                await db.collection('users').doc(currentUser.uid).update({
                    fullName: fullName,
                    phoneNumber: phoneNumber,
                    bankName: bankName,
                    accountNumber: accountNumber,
                    accountHolder: accountHolder,
                    updatedAt: new Date().toISOString()
                });

                showSuccess('ì •ë³´ê°€ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤! âœ…');
                
                // ê²½ê³  ë©”ì‹œì§€ ìˆ¨ê¸°ê¸°
                document.getElementById('profile-warning').classList.add('hidden');

            } catch (error) {
                console.error('ì €ì¥ ì‹¤íŒ¨:', error);
                alert('ì •ë³´ ì €ì¥ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤: ' + error.message);
            }
        });

        // ==================== ë¡œê·¸ì•„ì›ƒ ====================
        document.getElementById('logout-button').addEventListener('click', () => {
            auth.signOut().then(() => {
                window.location.href = "index.html";
            });
        });

        // ==================== ë§í¬ ë³µì‚¬ ====================
        document.getElementById('copy-link-button').addEventListener('click', () => {
            const linkInput = document.getElementById('ref-link');
            linkInput.select();
            document.execCommand('copy');
            alert('ì˜ì—… ë§í¬ê°€ ë³µì‚¬ë˜ì—ˆìŠµë‹ˆë‹¤!');
        });

        // ==================== DB ë°ì´í„° ë¡œë“œ ====================
        async function loadMyDbs() {
            try {
                console.log(`ğŸ“Š DB ë°ì´í„° ë¡œë“œ ì‹œì‘: ${myReferralCode}`);
                const startTime = performance.now();

                const response = await fetch(`${GAS_URL}?action=getDbsByRef&ref=${myReferralCode}`);
                const result = await response.json();

                const endTime = performance.now();
                console.log(`âœ… DB ë°ì´í„° ë¡œë“œ ì™„ë£Œ (${Math.round(endTime - startTime)}ms)`);

                if (!result.success) {
                    throw new Error(result.message || "ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.");
                }

                myDbs = result.data;
                renderDashboard();
                document.getElementById('loading-spinner').classList.add('hidden');
                document.getElementById('dashboard-content').classList.remove('hidden');

            } catch (error) {
                console.error("DB ë¡œë“œ ì‹¤íŒ¨:", error);
                showError("ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ”ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤: " + error.message);
                document.getElementById('loading-spinner').classList.add('hidden');
                document.getElementById('dashboard-content').classList.remove('hidden');
            }
        }

        // ==================== ëŒ€ì‹œë³´ë“œ ë Œë”ë§ ====================
        function renderDashboard() {
            const now = new Date();
            const currentMonth = now.getMonth();
            const currentYear = now.getFullYear();

            let currentMonthSales = 0;
            let currentMonthCommission = 0;
            let currentMonthTax = 0;
            let currentMonthFinal = 0;
            let currentMonthApproved = 0;
            let currentMonthTotal = 0;

            let totalApproved = 0;

            myDbs.forEach(db => {
                const submittedDate = new Date(db.submittedAt);
                const isSubmittedThisMonth = submittedDate.getMonth() === currentMonth && submittedDate.getFullYear() === currentYear;

                if (db.status === 'ìŠ¹ì¸ë¨') {
                    totalApproved++;
                    
                    if (db.approvedAt) {
                        const approvedDate = new Date(db.approvedAt);
                        const isApprovedThisMonth = approvedDate.getMonth() === currentMonth && approvedDate.getFullYear() === currentYear;
                        
                        if (isApprovedThisMonth) {
                            currentMonthApproved++;
                            currentMonthSales += (db.saleAmount || 0);
                            currentMonthCommission += (db.commission || 0);
                            currentMonthTax += (db.withholdingTax || 0);
                            currentMonthFinal += (db.finalAmount || 0);
                        }
                    }
                }

                if (isSubmittedThisMonth) {
                    currentMonthTotal++;
                }
            });

            const paymentDate = new Date(currentYear, currentMonth + 1, 10);
            const paymentDateStr = formatKoreanDate(paymentDate);
            document.getElementById('payment-date').textContent = `${paymentDateStr} (ìµì›” 10ì¼)`;

            document.getElementById('current-month-sales').textContent = `â‚©${currentMonthSales.toLocaleString()}`;
            document.getElementById('current-month-commission').textContent = `â‚©${currentMonthCommission.toLocaleString()}`;
            document.getElementById('current-month-tax').textContent = `-â‚©${currentMonthTax.toLocaleString()}`;
            document.getElementById('current-month-final').textContent = `â‚©${currentMonthFinal.toLocaleString()}`;
            
            document.getElementById('current-month-db-count').textContent = `${currentMonthTotal} ê±´`;
            document.getElementById('current-month-db-detail').textContent = `(ìŠ¹ì¸ ${currentMonthApproved}ê±´)`;
            
            document.getElementById('total-db-count').textContent = `${myDbs.length} ê±´`;
            document.getElementById('total-db-detail').textContent = `(ìŠ¹ì¸ ${totalApproved}ê±´)`;

            renderDbList();
        }

        // ==================== DB ëª©ë¡ ë Œë”ë§ ====================
        function renderDbList() {
            const tbody = document.getElementById('db-list-tbody');
            tbody.innerHTML = '';

            if (myDbs.length === 0) {
                tbody.innerHTML = '<tr><td colspan="8" class="px-6 py-8 text-center text-gray-500">ì•„ì§ ìœ ì…ëœ DBê°€ ì—†ìŠµë‹ˆë‹¤.</td></tr>';
                return;
            }

            myDbs.forEach(db => {
                const row = document.createElement('tr');
                row.className = 'hover:bg-gray-50';
                
                const statusClass = db.status === 'ìŠ¹ì¸ë¨' ? 'bg-green-100 text-green-800' : 'bg-yellow-100 text-yellow-800';
                const statusText = db.status || 'ëŒ€ê¸°ì¤‘';
                
                const saleAmount = db.saleAmount ? `â‚©${parseInt(db.saleAmount).toLocaleString()}` : 'ë¯¸ì…ë ¥';
                const commission = db.commission ? `â‚©${parseInt(db.commission).toLocaleString()}` : 'â‚©0';
                const commissionRate = db.commissionRate ? `(${db.commissionRate}%)` : '';
                const withholdingTax = db.withholdingTax ? `â‚©${parseInt(db.withholdingTax).toLocaleString()}` : 'â‚©0';
                const finalAmount = db.finalAmount ? `â‚©${parseInt(db.finalAmount).toLocaleString()}` : 'â‚©0';
                
                const submittedAt = formatKoreanDateTime(db.submittedAt);
                
                let paymentDateStr = '-';
                if (db.approvedAt) {
                    const approvedDate = new Date(db.approvedAt);
                    const paymentDate = new Date(approvedDate.getFullYear(), approvedDate.getMonth() + 1, 10);
                    paymentDateStr = formatKoreanDate(paymentDate);
                }

                row.innerHTML = `
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${submittedAt}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${db.customerName || 'N/A'}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${saleAmount}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-blue-600 font-semibold">
                        ${commission}
                        <span class="text-xs text-gray-500">${commissionRate}</span>
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-red-600">${withholdingTax}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-green-600 font-bold">${finalAmount}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-indigo-600">${paymentDateStr}</td>
                    <td class="px-6 py-4 whitespace-nowrap">
                        <span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full ${statusClass}">
                            ${statusText}
                        </span>
                    </td>
                `;
                tbody.appendChild(row);
            });
        }

        // ==================== ì—ëŸ¬/ì„±ê³µ ë©”ì‹œì§€ ====================
        function showError(message) {
            document.getElementById('error-text').textContent = message;
            document.getElementById('error-message').classList.remove('hidden');
        }

        function showSuccess(message) {
            document.getElementById('success-text').textContent = message;
            document.getElementById('success-message').classList.remove('hidden');
            setTimeout(() => {
                document.getElementById('success-message').classList.add('hidden');
            }, 3000);
        }
    </script>
</body>
</html>
